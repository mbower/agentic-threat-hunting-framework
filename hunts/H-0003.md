# H-0003: DigitStealer macOS Infostealer Detection

**Hunt Metadata**

- **Date:** 2025-11-18
- **Hunter:** Sydney
- **Status:** Completed
- **MITRE ATT&CK:** T1539 - Steal Web Session Cookie, T1555 - Credentials from Password Stores, T1059.002 - AppleScript

---

## LEARN: Prepare the Hunt

### Hypothesis Statement

Detect DigitStealer macOS infostealer infection attempts targeting credential stores and financial data on macOS endpoints, based on recent threat intelligence reporting. The malware uses multi-stage script execution, TCC privacy permission manipulation, and hardware-level VM detection to evade analysis while exfiltrating credentials, browser data, and cryptocurrency wallets.

### ABLE Scoping

Define your hunt scope using the ABLE framework:

| **Field**   | **Your Input** |
|-------------|----------------|
| **Actor** *(Optional)* | Unknown financially motivated threat actor - Targets cryptocurrency users and financial services |
| **Behavior** | Multi-stage macOS infostealer using bash → osascript → JXA execution chains to bypass Gatekeeper, manipulate TCC privacy permissions, exfiltrate credentials/wallets via goldenticketsshop[.]com C2 infrastructure |
| **Location** | macOS endpoints (specifically Apple Silicon M2+ systems), targeting ~/Library/Keychains/, browser credential stores, cryptocurrency wallet applications |
| **Evidence** | **Source:** macOS EDR telemetry (process execution, network connections)<br>**Key Fields:** process_name, command_line, parent_process, network_destination, file_path<br>**Example:** bash executing `curl -fsSL \| bash` piped commands, osascript with remote content, `tccutil reset All` commands, connections to goldenticketsshop[.]com<br><br>**Source:** DNS query logs<br>**Key Fields:** query_domain, query_type, response<br>**Example:** DNS TXT record queries to goldenticketsshop[.]com for dynamic payload retrieval |

### Threat Intel & Research

- **MITRE ATT&CK Techniques:**
  - `T1566.001 - Spearphishing Attachment` (malicious DMG distribution)
  - `T1204.002 - User Execution: Malicious File` (drag-to-terminal bypass)
  - `T1059.004 - Unix Shell` (bash execution chains)
  - `T1059.002 - AppleScript` (osascript/JXA payloads)
  - `T1027 - Obfuscated Files or Information` (Base64 encoding)
  - `T1497.001 - Virtualization/Sandbox Evasion` (system_profiler VM detection)
  - `T1480.001 - Execution Guardrails` (locale-based targeting)
  - `T1562.001 - Impair Defenses` (TCC privacy permission resets)
  - `T1555 - Credentials from Password Stores` (keychain theft)
  - `T1552.001 - Unsecured Credentials in Files` (wallet harvesting)
  - `T1071.001 - Application Layer Protocol: Web` (C2 API endpoints)
  - `T1071.004 - Application Layer Protocol: DNS` (TXT record payload delivery)
  - `T1565.001 - Stored Data Manipulation` (Ledger Live application tampering)

- **CTI Sources & References:**
  - Jamf Threat Labs: https://www.jamf.com/blog/jtl-digitstealer-macos-infostealer-analysis/
  - Initial discovery reporting on DigitStealer campaign targeting macOS users
  - Typosquatted domain dynamiclake.org (vs legitimate dynamiclake.com)

- **Historical Context:**
  - First hunt for this specific macOS infostealer variant
  - Part of broader macOS threat landscape monitoring
  - Response to emerging macOS-targeted financial malware campaigns

---

## OBSERVE: Expected Behaviors

### What Normal Looks Like

- **Legitimate TCC resets:** Apple installers using `tccutil reset All com.apple.installer` for system-level installations
- **Enterprise device management:** MDM agents (e.g., Jamf, Munki) performing TCC resets for policy enforcement
- **Administrative scripts:** IT automation using osascript for legitimate administrative tasks
- **System profiling:** Hardware inventory tools running system_profiler for asset management
- **Keychain operations:** CloudKeychainProxy events for iCloud keychain synchronization

### What Suspicious Looks Like

- **Multi-stage execution chains:** bash → curl piping to bash → osascript → JXA in rapid succession from non-administrative users
- **Unauthorized TCC manipulation:** `tccutil reset All` without installer context, especially targeting All permissions
- **Remote script execution:** `curl -fsSL | bash` patterns fetching and executing remote content
- **Hardware enumeration for evasion:** system_profiler querying SPHardwareDataType followed by virtualization checks via sysctl
- **C2 communications:** Connections to goldenticketsshop[.]com, sweetseedsbeep[.]com, nevadabtcshill[.]com, ledgmanyman[.]com
- **DNS TXT record retrieval:** Queries for TXT records to known malicious domains for dynamic payload delivery
- **Credential access patterns:** Keychain database reads (login.keychain-db) outside normal application context
- **Application tampering:** Modifications to Ledger Live app.asar or app.json configuration files

### Expected Observables

- **Processes:**
  - bash with curl pipe patterns: `curl -fsSL <URL> | bash`
  - osascript executing remote content or password prompts
  - nohup spawning backgrounded remote payloads
  - tccutil with suspicious reset targets
  - system_profiler with hardware enumeration

- **Network:**
  - Connections to goldenticketsshop[.]com (primary C2)
  - API endpoints: /api/credentials, /api/grabber, /api/log, /api/poll
  - ~10 second polling intervals to C2 infrastructure
  - DNS TXT queries to malicious domains
  - Cloudflare Pages (pages.dev) connections with ASPX endpoints

- **Files:**
  - /tmp/wid.txt (unique ID storage)
  - ~/...txt (password validation cache)
  - ~/Library/LaunchAgents/goldenticketsshop.com.plist (persistence)
  - Modified Ledger Live files: app.asar, app.json
  - DynamicLake.dmg or similar malicious disk images

- **Registry:** N/A (macOS-specific - LaunchAgents instead)

- **Authentication:**
  - Unsolicited password prompts via AppleScript dialogs
  - Privilege escalation attempts

---

## CHECK: Execute & Analyze

### Data Source Information

- **Index/Data Source:** macOS EDR database (SQL)
- **Time Range:** Full historical dataset - all available EDR telemetry
- **Events Analyzed:** 134,655+ events across 570+ specific indicator searches
- **Data Quality:** Good - Comprehensive coverage across entire macOS fleet with process execution, network connections, command-line arguments, and file system monitoring

### Hunting Queries

#### Initial Query - C2 Domain Detection

```sql
SELECT
    dest_domain,
    src_host,
    user,
    COUNT(*) as connection_count
FROM edr_network_events
WHERE platform = 'macos'
  AND dest_domain IN (
    'goldenticketsshop.com',
    'sweetseedsbeep.com',
    'nevadabtcshill.com',
    'ledgmanyman.com'
  )
GROUP BY dest_domain, src_host, user
ORDER BY connection_count DESC;
```

**Query Notes:**

- **Results:** 0 connections detected to any malicious C2 domains
- **Coverage:** Full macOS endpoint fleet searched
- **Assessment:** No active C2 communications observed - strong indicator that fleet is not compromised
- **False Positives:** None - these are confirmed malicious domains

#### Query 2 - TCC Permission Manipulation

```sql
SELECT
    timestamp,
    host,
    user,
    parent_process,
    command_line,
    CASE
        WHEN command_line LIKE '%reset All%' AND command_line NOT LIKE '%com.apple.installer%'
            THEN 'Full Reset - High Risk'
        WHEN command_line LIKE '%reset All com.apple.installer%'
            THEN 'Apple Installer - Expected'
        WHEN command_line LIKE '%ListenEvent%'
            THEN 'Specific Permission - Medium Risk'
        ELSE 'Other Reset'
    END as tcc_scope
FROM edr_process_events
WHERE platform = 'macos'
  AND process_name = 'tccutil'
  AND command_line LIKE '%reset%'
ORDER BY timestamp DESC;
```

**Query Results:**

- **Total Events:** 2 instances detected
- **Instance 1:**
  - Command: `tccutil reset All com.apple.installer`
  - Executed by: root via bash
  - Assessment: ✅ Benign - Standard Apple installer operation

- **Instance 2:**
  - Command: `tccutil reset ListenEvent <MDM_Agent>`
  - Context: Enterprise device management activity
  - Assessment: ✅ Benign - Authorized enterprise MDM agent

**Query Notes:**

- Both TCC reset instances have legitimate business context
- No unauthorized privacy permission manipulation detected
- DigitStealer typically uses `tccutil reset All` without installer context - not observed

#### Query 3 - Multi-Stage Script Execution Chains

```sql
WITH bash_curl_events AS (
    SELECT
        timestamp as bash_time,
        host,
        user,
        parent_process,
        command_line as bash_command,
        'Remote Script Execution via Curl Pipe' as execution_pattern
    FROM edr_process_events
    WHERE platform = 'macos'
      AND process_name = 'bash'
      AND command_line LIKE '%curl%'
      AND command_line LIKE '%|%bash%'
),
osascript_events AS (
    SELECT
        timestamp as osascript_time,
        host,
        command_line as osascript_command
    FROM edr_process_events
    WHERE platform = 'macos'
      AND process_name = 'osascript'
)
SELECT
    b.bash_time,
    b.host,
    b.user,
    b.parent_process,
    b.bash_command,
    o.osascript_command,
    b.execution_pattern
FROM bash_curl_events b
LEFT JOIN osascript_events o
    ON b.host = o.host
    AND o.osascript_time BETWEEN b.bash_time AND DATEADD(minute, 5, b.bash_time)
ORDER BY b.bash_time DESC;
```

**Query Results:**

- **Bash executions:** 11,625 total events analyzed
- **Curl pipe patterns:** 0 suspicious chains detected
- **Multi-stage chains:** No bash → osascript execution sequences matching DigitStealer behavior
- **Assessment:** No remote script execution patterns consistent with DigitStealer infection

#### Query 4 - Hardware VM Detection Patterns

```sql
WITH system_profiler_events AS (
    SELECT
        timestamp as profiler_time,
        host,
        user,
        parent_process,
        command_line as profiler_command
    FROM edr_process_events
    WHERE platform = 'macos'
      AND process_name = 'system_profiler'
      AND command_line LIKE '%SPHardwareDataType%'
),
sysctl_events AS (
    SELECT
        timestamp as sysctl_time,
        host,
        command_line as sysctl_command
    FROM edr_process_events
    WHERE platform = 'macos'
      AND process_name = 'sysctl'
      AND command_line LIKE '%hw.%'
)
SELECT
    sp.host,
    sp.user,
    sp.parent_process,
    sp.profiler_command,
    s.sysctl_command,
    COUNT(*) as detection_count
FROM system_profiler_events sp
INNER JOIN sysctl_events s
    ON sp.host = s.host
    AND ABS(TIMESTAMPDIFF(SECOND, sp.profiler_time, s.sysctl_time)) < 60
GROUP BY sp.host, sp.user, sp.parent_process, sp.profiler_command, s.sysctl_command;
```

**Query Results:**

- **system_profiler executions:** 65,481 events (routine system information queries)
- **sysctl hardware queries:** Analyzed for Apple Silicon M2+ processor enumeration
- **VM detection patterns:** 0 instances matching DigitStealer evasion techniques
- **Assessment:** No hardware-level virtualization detection consistent with malware anti-analysis

#### Query 5 - AppleScript/JXA Execution Monitoring

```sql
SELECT
    host,
    user,
    command_line,
    CASE
        WHEN command_line LIKE '%curl%' THEN 'Remote Content Execution'
        WHEN command_line LIKE '%password%' THEN 'Password Prompt'
        WHEN command_line LIKE '%Base64%' OR command_line LIKE '%base64%' THEN 'Encoded Payload'
        WHEN command_line LIKE '%keychain%' THEN 'Keychain Access'
        ELSE 'Standard Execution'
    END as suspicious_indicators,
    COUNT(*) as event_count
FROM edr_process_events
WHERE platform = 'macos'
  AND process_name = 'osascript'
GROUP BY host, user, command_line
HAVING suspicious_indicators != 'Standard Execution'
ORDER BY event_count DESC;
```

**Query Results:**

- **Total osascript executions:** 813 events
- **Suspicious patterns:** 0 events with DigitStealer characteristics
  - No password harvesting dialogs
  - No Base64-encoded JXA payloads
  - No keychain access patterns
- **Assessment:** All osascript executions within normal administrative bounds

#### Refined Query - Keychain Access Monitoring

```sql
SELECT
    timestamp,
    host,
    user,
    process_name,
    parent_process,
    file_path,
    file_action
FROM edr_file_events
WHERE platform = 'macos'
  AND file_path LIKE '%/Library/Keychains/login.keychain-db'
  AND process_name NOT IN (
    'SecurityAgent',
    'secd',
    'securityd',
    'CloudKeychainProxy',
    'Safari',
    'Chrome',
    'Firefox',
    'Brave',
    'Edge'
  )
ORDER BY timestamp DESC;
```

**Refinement Rationale:**

- Initial broad search returned 134,655 CloudKeychainProxy events (normal iCloud sync)
- Refined to exclude legitimate keychain access processes
- Focus on unauthorized keychain database access attempts
- **Results:** No unauthorized keychain access detected

### Visualization & Analytics

- **Time-series analysis:** Event volume over time showed consistent patterns with no anomalous spikes
- **Host distribution:** Activity distributed evenly across 2,533 macOS endpoints
- **Process execution heatmap:** CloudKeychainProxy (134,655), Keychain Circle Notifications (82,921), sysctl (65,481), bash (11,625), osascript (813)
- **Network connection patterns:** No connections to known malicious infrastructure
- **TCC reset timeline:** 2 instances over historical dataset - both with legitimate context

### Query Performance

- **What Worked Well:**
  - C2 domain searches - clear negative result provided high confidence
  - TCC monitoring - low false positive rate with business context attribution
  - Multi-stage execution chain detection - effective at identifying script relationships
  - Hardware enumeration patterns - successfully distinguished malware evasion from legitimate inventory

- **What Didn't Work:**
  - Initial keychain access queries returned excessive legitimate activity (134K+ events)
  - Required refinement to exclude normal system processes

- **Iterations Made:**
  - Iteration 1: Broad keychain access search → 134,655 events
  - Iteration 2: Refined to exclude legitimate processes (SecurityAgent, secd, CloudKeychainProxy, browsers)
  - Iteration 3: Added parent process context for better false positive reduction

---

## KEEP: Findings & Response

### Executive Summary

Completed comprehensive threat hunt for DigitStealer macOS infostealer across entire macOS endpoint fleet, analyzing 134,655+ events across 570+ specific indicator and behavioral searches. **Hypothesis disproved - no DigitStealer infection detected.** All observed activity aligns with legitimate enterprise operations. The 2 TCC reset instances identified were attributed to authorized Apple installers and enterprise MDM agents. No connections to malicious C2 infrastructure, no multi-stage script execution chains, and no unauthorized credential access patterns were observed. Environment assessed as **low risk** for this threat.

### Findings

| **Finding** | **Ticket** | **Description** |
|-------------|-----------|-----------------|
| False Positive | N/A | TCC reset by Apple installer - Standard system installation behavior |
| False Positive | N/A | TCC reset by enterprise MDM agent - Authorized enterprise device management |
| True Negative | N/A | Zero connections to goldenticketsshop[.]com C2 infrastructure across entire macOS fleet |
| True Negative | N/A | No multi-stage bash → osascript → JXA execution chains detected across all bash events |
| True Negative | N/A | No unauthorized keychain database access outside legitimate system processes |
| True Negative | N/A | No hardware VM detection patterns consistent with DigitStealer evasion techniques |

**True Positives:** 0 - No confirmed DigitStealer infections
**False Positives:** 2 - Both TCC reset events had legitimate business context
**Suspicious Events:** 0 - No activity requiring further investigation

### Detection Logic

**Automation Opportunity:**

Yes - This hunt logic can become automated detection with the following behavioral patterns:

1. **Unauthorized TCC Privacy Manipulation:** Detect `tccutil reset All` executed outside Apple installer context (without com.apple.installer in command line) → Medium severity, investigate within 4 hours
2. **Multi-Stage Script Execution Chain:** Bash process executing curl piped to bash, followed by osascript execution on same host within 5-minute window → High severity, immediate investigation
3. **Remote Script Execution Pattern:** Bash executing curl with pipe to shell interpreter (`curl -fsSL | bash` patterns) from non-administrative users → Medium severity
4. **Hardware Enumeration for Anti-VM:** system_profiler querying SPHardwareDataType followed by sysctl hardware queries within 60 seconds → Low severity, requires correlation with other suspicious behaviors

**Proposed Detection:**

```yaml
title: macOS Infostealer Behavioral Detection - Multi-Stage Execution and TCC Manipulation
id: macos-infostealer-behavioral-2025
status: production
description: Detects macOS infostealer behavioral patterns including unauthorized TCC manipulation, multi-stage script execution chains, and remote code execution via curl pipe
references:
    - https://www.jamf.com/blog/jtl-digitstealer-macos-infostealer-analysis/
    - attack.mitre.org/techniques/T1562/001/
    - attack.mitre.org/techniques/T1059/004/
author: Sydney
date: 2025-11-18
tags:
    - attack.credential_access
    - attack.t1555
    - attack.t1539
    - attack.defense_evasion
    - attack.t1562.001
    - attack.execution
    - attack.t1059.004
    - attack.t1059.002
logsource:
    product: macos
    service: edr
detection:
    # Unauthorized TCC Privacy Permission Reset
    selection_tcc_reset:
        process_name: 'tccutil'
        command_line|contains: 'reset All'

    filter_apple_installer:
        command_line|contains: 'com.apple.installer'

    filter_known_mdm_agents:
        parent_process|endswith:
            - '/jamf'
            - '/munki'
            # Add your authorized MDM agents here

    # Remote Script Execution via Curl Pipe
    selection_curl_pipe:
        process_name: 'bash'
        command_line|contains|all:
            - 'curl'
            - '|'
        command_line|contains:
            - 'bash'
            - 'sh'

    filter_admin_users:
        user|startswith:
            - 'admin'
            - 'root'
            # Add your authorized administrative users here

    # Hardware Enumeration for Anti-VM
    selection_hardware_enum:
        process_name: 'system_profiler'
        command_line|contains: 'SPHardwareDataType'

    condition: (selection_tcc_reset and not filter_apple_installer and not filter_known_mdm_agents) or (selection_curl_pipe and not filter_admin_users)
fields:
    - host
    - user
    - process_name
    - command_line
    - parent_process
    - timestamp
falsepositives:
    - Apple system installers performing TCC resets
    - Enterprise MDM agents (add to filter_known_mdm_agents)
    - Legitimate administrative scripts using curl (add to filter_admin_users)
    - IT automation frameworks
level: high
```

### Lessons Learned

**What Worked Well:**

- **Indicator-based hunting:** C2 domain searches provided immediate high-confidence assessment
- **Behavioral pattern detection:** Multi-stage execution chain queries effectively identified script relationships
- **Contextual analysis:** Evaluating TCC resets with parent process and business context reduced false positives
- **Comprehensive coverage:** Searching entire macOS endpoint fleet provided full visibility
- **Threat intelligence integration:** Using detailed IOCs from Jamf reporting enabled precise hunting

**What Could Be Improved:**

- **Initial query tuning:** Keychain access queries required significant refinement to reduce legitimate activity noise
- **Behavioral baseline establishment:** Need documented baseline for normal TCC reset frequency, multi-stage script execution patterns, and hardware enumeration activity
- **Process whitelisting:** Should maintain whitelist of authorized MDM agents and administrative scripts for automated filtering
- **Execution chain correlation:** Time-window correlation between bash and osascript could be enhanced with process tree analysis

**Telemetry Gaps Identified:**

1. **Process tree relationships:** Limited parent-child process lineage visibility for multi-stage execution chain analysis
2. **Application integrity monitoring:** No behavioral detection for application bundle tampering or configuration file manipulation
3. **Keychain access context:** Insufficient telemetry to attribute keychain access to legitimate application workflows vs. unauthorized access
4. **LaunchAgent behavioral monitoring:** Need enhanced detection for persistence mechanisms beyond file creation (e.g., execution frequency, network activity)
5. **Script content visibility:** Limited ability to inspect script content executed via curl pipe or osascript for malicious patterns

### Follow-up Actions

- [x] ~~Escalate true positives to incident response~~ - No infections detected
- [ ] Create behavioral detection rules - Develop detections for multi-stage execution chains, TCC manipulation, and remote script execution patterns (Sigma rule drafted above)
- [ ] Establish behavioral baselines - Document normal TCC reset patterns, administrative script execution, and hardware enumeration activity
- [ ] Address telemetry gaps - Enhance process tree visibility and script content inspection capabilities
- [ ] Schedule recurring hunt execution - Quarterly hunt for macOS infostealer behaviors, not campaign-specific
- [ ] Document findings in knowledge base - Share behavioral hunting methodology and detection patterns with SOC
- [ ] Share insights with SOC/IR/TI teams - Brief on macOS multi-stage execution TTPs and behavioral detection opportunities
- [ ] Whitelist legitimate activity - Work with IT to identify and whitelist authorized MDM agents and administrative scripts
- [ ] Enhance persistence monitoring - Implement behavioral detection for LaunchAgent abuse patterns
- [ ] User awareness training - Educate on social engineering tactics: drag-to-terminal execution, Gatekeeper bypasses, and privacy permission manipulation

### Follow-up Hunts

- **H-0004:** macOS LaunchAgent persistence hunt - Expand detection to all persistence mechanisms, not just DigitStealer-specific
- **H-0005:** Application bundle tampering detection - Hunt for unauthorized modifications to app.asar, Info.plist, or other application components
- **H-0006:** macOS credential access patterns - Broader hunt for keychain theft, browser credential harvesting, wallet exfiltration across all malware families
- **H-0007:** DNS exfiltration and dynamic payload delivery - Hunt for DNS TXT record abuse, DNS tunneling, and DNS-based C2
- **H-0008:** macOS Gatekeeper bypass techniques - Hunt for drag-to-terminal execution, quarantine attribute removal, and other bypass methods

---

**Hunt Completed:** 2025-11-18
**Next Review:** Quarterly (2026-02-18) or triggered by new DigitStealer campaign intelligence
