# H-0001: SSH Brute Force Detection (T1110.001)

**Status**: Active

**Learn**

Adversaries commonly use automated tools to perform brute force attacks against SSH services, attempting to guess valid credentials through rapid, repeated authentication attempts. This technique is classified as **T1110.001 - Brute Force: Password Guessing** and falls under the **Credential Access** tactic (TA0006).

SSH brute force attacks typically exhibit distinct patterns:
- **High volume of failed authentication attempts** from a single source IP
- **Short time duration** between attempts (often seconds or less)
- **Multiple usernames targeted** from the same source
- **Common/default credentials** attempted first (root, admin, user, test)

Key indicators to understand:
- **Source IP reputation:** Internet scanners vs. targeted attacks
- **Attempt rate:** Automated tools generate higher attempts per minute
- **Username patterns:** Random usernames vs. valid account enumeration
- **Time of attack:** After-hours attacks may indicate malicious intent
- **Geographic anomalies:** Authentication attempts from unexpected countries

Common adversary patterns:
- Distributed attacks from multiple IPs (harder to detect)
- Low-and-slow attacks to evade rate-based detection
- Targeting of high-value accounts (root, service accounts)
- Successful authentication followed by lateral movement

**Context:**
- **Initial Trigger:** SOC alert #2847 detected SSH login anomalies over weekend
- **Business Impact:** Successful brute force could lead to initial access and persistence
- **Detection Gap:** Dev and CI/CD environments lack centralized auth logging
- **Data Limitation:** No geographic IP enrichment for anomalous location detection

**Observe**

Adversaries using automated SSH brute force tools will generate authentication activity with distinct characteristics. We expect to observe:

1. **High volume failed authentication events** - Single source IP generating >10 failed SSH login attempts within 24 hours
2. **Multiple username attempts** - Source IP attempting authentication as different users (root, admin, service accounts, common names)
3. **Rapid attempt rate** - Failed authentication attempts occurring at >0.5 attempts per minute, indicating automated tooling
4. **External source IPs** - Originating from internet-facing IPs (non-RFC1918), often from known hosting providers or VPS services
5. **No successful authentication** - Pattern of sustained failures with no corresponding successful login (unless attack succeeds)

**Check**

### Query 1: SSH Failed Authentication Aggregation

```spl
# Aggregate failed SSH authentication by source IP and destination host
# Calculate attempt rate and identify high-volume brute force candidates
index=linux_secure sourcetype=linux_secure action=failure
| stats count as failed_attempts,
        dc(user) as unique_users,
        values(user) as attempted_users,
        earliest(_time) as first_attempt,
        latest(_time) as last_attempt
        by src_ip, dest_host
| where failed_attempts > 10
| eval duration=last_attempt-first_attempt
| eval attempts_per_minute=round(failed_attempts/(duration/60),2)
| where NOT (src_ip LIKE "10.%" OR src_ip LIKE "172.16.%" OR src_ip LIKE "192.168.%")
| sort - failed_attempts
| head 1000
```

**Query Logic:**
- Filter to failed SSH authentication events in linux_secure index
- Aggregate by source IP and destination host
- Count total failed attempts and unique users targeted
- Calculate time range and attempt rate (attempts per minute)
- Apply threshold: >10 failed attempts (refined from initial >5 based on execution feedback)
- Exclude internal IP ranges (10.x, 172.16.x, 192.168.x) to focus on external threats
- Sort by highest failure count to prioritize investigation

**Time Range:** Last 24 hours (`earliest=-24h latest=now`)
**Result Cap:** 1000 rows
**Expected Runtime:** <5 seconds

### Query 2: Successful Authentication After Failed Attempts

```spl
# Identify source IPs with failed attempts followed by successful login (potential compromise)
index=linux_secure sourcetype=linux_secure
| stats count(eval(action="failure")) as failures,
        count(eval(action="success")) as successes,
        values(user) as users
        by src_ip, dest_host
| where failures > 5 AND successes > 0
| where NOT (src_ip LIKE "10.%" OR src_ip LIKE "172.16.%" OR src_ip LIKE "192.168.%")
| sort - failures
```

### Manual Validation Steps

```bash
# On suspected target host, check recent SSH authentication logs
grep "Failed password" /var/log/auth.log | tail -100
grep "Accepted password" /var/log/auth.log | tail -50

# Check for active SSH sessions from suspicious IPs
who -a
netstat -tnp | grep :22 | grep ESTABLISHED

# Review user account status for targeted accounts
lastlog | grep -E "(root|admin|service_account_name)"

# Check for post-compromise activity (lateral movement, persistence)
crontab -l
systemctl list-units --type=service --state=running | grep -v "^‚óè"
ls -la /home/*/.ssh/authorized_keys
```

**Keep**

### Expected Findings
- **True Positives:**
  - Internet-based scanners conducting automated brute force (high volume, common usernames)
  - Targeted attacks attempting to guess credentials for real user accounts
  - Successful brute force followed by authentication (critical - immediate IR)
- **False Positives:**
  - Legitimate users mistyping passwords (internal IPs, low attempt count, followed by success)
  - Approved penetration testing or vulnerability scanning (coordinate with security testing team)
  - Automated monitoring tools with misconfigured credentials (regular interval, same username)
- **Benign Patterns:**
  - Known internet scanner IPs (Shodan, Censys, security researchers) with <10 attempts
  - Internal IP ranges with failed attempts (legitimate user error)

### Lessons Learned
- [x] Initial threshold of >5 attempts too low (75% noise from internet scanners)
- [x] Exclude internal IP ranges to reduce false positives from legitimate users
- [ ] Document baseline of normal failed authentication volume per host
- [ ] Identify which user accounts are real vs. default/test credentials
- [ ] Correlate with threat intelligence feeds for known malicious IPs
- [ ] Add temporal logic for "newly seen in 7 days" source IPs
- [ ] Implement geographic IP enrichment to flag anomalous countries

### Response Actions
If high-confidence SSH brute force identified:
1. **Triage source IP** - Check reputation (VirusTotal, AbuseIPDB, threat intel feeds)
2. **Verify targeted accounts** - Determine if real user accounts or default credentials
3. **Check for successful authentication** - Run Query 2 to identify potential compromise
4. **Block source IP** - Add to firewall deny list or WAF block rule
5. **Review authentication logs on target host** - Manual validation for successful logins
6. **Hunt for post-compromise activity** - Check for lateral movement, persistence, data access
7. **Notify affected system owners** - Alert on targeted systems and users
8. **Document findings** - Create incident ticket if compromise confirmed

### Follow-up Hunts
- H-XXXX: SSH Key-Based Authentication Anomalies (T1078.004)
- H-XXXX: Successful SSH Logins from New Geographic Locations
- H-XXXX: Lateral Movement via SSH from Compromised Hosts (T1021.004)
- H-XXXX: Linux Account Manipulation After Successful Brute Force (T1098)
- H-XXXX: Distributed SSH Brute Force from Multiple Source IPs

### Automation Opportunities
- Create scheduled search running daily, alerting on >20 failed attempts per source IP
- Implement automated IP blocking for sources exceeding 50 failed attempts
- Build baseline model of normal failed authentication volume by host
- Integrate with threat intelligence feeds for automatic IP reputation scoring
- Deploy honeypot SSH service to identify and track brute force source IPs
- Implement rate limiting on SSH service (fail2ban or similar)
