# H-0002: Linux Crontab Persistence Detection (T1053.003)

**Learn**

Adversaries may abuse cron on Linux systems to establish persistence by scheduling malicious commands or scripts to execute at system startup or on a defined schedule. Cron jobs are commonly used by threat actors to maintain access, execute payloads, or perform reconnaissance activities. This technique allows attackers to survive system reboots and maintain long-term access to compromised hosts.

Key persistence locations:
- User crontabs: `/var/spool/cron/crontabs/*`
- System-wide: `/etc/crontab`, `/etc/cron.d/*`
- Scheduled directories: `/etc/cron.hourly/`, `/etc/cron.daily/`, `/etc/cron.weekly/`, `/etc/cron.monthly/`

Common adversary patterns:
- Unusual timing patterns (every minute, odd schedules)
- Commands with network activity (curl, wget, nc)
- Obfuscated or base64-encoded commands
- Execution from temporary directories (/tmp, /dev/shm)
- Reverse shells or callback mechanisms
- Crontab modifications by non-administrative users

**Observe**

Adversaries will modify crontab files to achieve persistence on Linux hosts. We expect to see:

1. **File modifications** to crontab-related files outside normal maintenance windows
2. **Suspicious commands** in cron entries containing:
   - Network utilities: `curl`, `wget`, `nc`, `ncat`, `socat`
   - Shell invocations: `bash -c`, `sh -c`, `/dev/tcp/`
   - Encoding: `base64`, `echo`, piped to `sh` or `bash`
   - Temporary paths: `/tmp`, `/dev/shm`, `/var/tmp`
3. **Unusual crontab users** - modifications by non-root, non-admin accounts
4. **Process execution** from cron daemon spawning unexpected commands
5. **New cron files** created in `/etc/cron.d/` with suspicious ownership

**Check**

### Query 1: File Integrity Monitoring for Crontab Changes

```bash
# For hosts with auditd logging
index=linux sourcetype=auditd
| search file_path IN ("/etc/crontab", "/etc/cron.d/*", "/var/spool/cron/crontabs/*", "/etc/cron.hourly/*", "/etc/cron.daily/*", "/etc/cron.weekly/*", "/etc/cron.monthly/*")
| search action IN ("modified", "created", "written")
| stats count by _time, host, user, file_path, action, process_name
| where user!="root" OR process_name!="crontab"
| sort -_time
```

### Query 2: Suspicious Cron Command Patterns

```bash
# For hosts collecting cron file contents
index=linux sourcetype=linux_secure OR sourcetype=syslog
| search "CRON" OR "crontab"
| rex field=_raw "(?<cron_command>\*.*\s+.+)"
| search cron_command IN ("*curl*", "*wget*", "*nc *", "*ncat*", "*socat*", "*bash -c*", "*sh -c*", "*base64*", "*/tmp/*", "*/dev/shm/*", "*python -c*", "*perl -e*", "*/dev/tcp/*")
| stats count by host, cron_command, user
| sort -count
```

### Query 3: Crontab Process Execution

```bash
# For hosts with process execution logging
index=linux sourcetype=linux_audit OR sourcetype=syslog
| search parent_process="*cron*" OR ppid_name="cron"
| search NOT (
    process_name IN ("logrotate", "anacron", "run-parts", "certbot", "apt", "yum", "updatedb")
)
| stats count by _time, host, user, process_name, command_line, parent_process
| where count < 5
| sort -_time
```

### Query 4: Crontab Modifications via crontab Command

```bash
# For hosts with command-line auditing
index=linux sourcetype=bash_history OR sourcetype=auditd
| search "crontab -e" OR "crontab -l" OR "crontab " OR "echo " AND "*cron*"
| stats count by _time, host, user, command
| where user!="root"
| sort -_time
```

### Manual Validation Steps

```bash
# On suspected hosts, check current crontabs
for user in $(cut -f1 -d: /etc/passwd); do
    echo "=== Crontab for $user ==="
    crontab -u $user -l 2>/dev/null
done

# Check system crontabs
cat /etc/crontab
ls -la /etc/cron.d/
ls -la /etc/cron.{hourly,daily,weekly,monthly}/

# Review recent modifications
find /etc/cron* /var/spool/cron -type f -mtime -7 -ls
find /etc/cron* /var/spool/cron -type f -exec grep -l "curl\|wget\|nc\|bash -c\|base64\|/tmp" {} \;
```

**Keep**

### Expected Findings
- **True Positives:** Unauthorized cron entries, reverse shell callbacks, persistence mechanisms
- **False Positives:** Legitimate system maintenance, backup jobs, monitoring agents, auto-update tasks
- **Benign Patterns:** Package manager crons (apt, yum), certificate renewals (certbot), log rotation, system health checks

### Lessons Learned
- [ ] Document baseline cron jobs per host type (web servers, DB servers, etc.)
- [ ] Whitelist known-good cron patterns to reduce false positives
- [ ] Track which user accounts legitimately use crontab
- [ ] Correlate cron execution times with network connections
- [ ] Review cron modifications during incident response timelines

### Response Actions
If malicious cron persistence identified:
1. Capture full crontab content and file timestamps before removal
2. Identify when the cron entry was added (file modification time, audit logs)
3. Determine what the cron job executed and where artifacts exist
4. Check if the scheduled command is still present on disk
5. Remove malicious cron entry and verify persistence removal
6. Hunt for related persistence mechanisms (systemd timers, at jobs, init scripts)
7. Review authentication logs for initial access vector

### Follow-up Hunts
- H-XXXX: Systemd timer persistence (T1053.006)
- H-XXXX: Linux backdoor analysis on hosts with suspicious crons
- H-XXXX: Network connections from cron-spawned processes
- H-XXXX: File execution from /tmp and /dev/shm directories

### Automation Opportunities
- Create detection rules for suspicious cron patterns in SIEM
- Implement file integrity monitoring alerts for crontab changes
- Build baseline of legitimate cron jobs per host type
- Alert on cron entries from non-administrative users
